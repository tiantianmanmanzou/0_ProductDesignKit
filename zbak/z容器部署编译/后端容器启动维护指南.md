# 后端容器启动维护指南

本文档总结了Excel2Doc项目后端服务的容器化启动方法和维护要点，帮助开发者快速启动和维护后端服务。

## 目录
- [环境要求](#环境要求)
- [快速启动](#快速启动)
- [详细配置说明](#详细配置说明)
- [优化特性](#优化特性)
- [常见问题](#常见问题)
- [维护操作](#维护操作)

## 环境要求

- Docker Desktop (支持ARM64架构)
- Docker Compose
- M3芯片Mac或其他ARM64环境

## 快速启动

### 1. 启动依赖服务
```bash
# 启动PostgreSQL和Redis
docker-compose up -d postgres redis

# 检查服务状态
docker-compose ps
```

### 2. 构建并启动后端服务
```bash
# 构建后端镜像
docker-compose build backend

# 启动后端服务
docker-compose up -d backend

# 检查服务日志
docker-compose logs -f backend
```

### 3. 验证服务
```bash
# 访问API文档
curl http://localhost:8000/docs

# 或在浏览器中打开
open http://localhost:8000/docs
```

## 详细配置说明

### Dockerfile 多阶段构建

项目使用多阶段构建解决ARM64编译问题：

**Stage 1: Builder (构建阶段)**
- 基于 `python:3.12-bookworm`
- 安装完整编译工具链（GCC, Rust等）
- 安装Python依赖到虚拟环境

**Stage 2: Runner (运行阶段)**
- 基于 `python:3.12-slim-bookworm`
- 只复制已编译的虚拟环境
- 创建低权限用户运行服务

### docker-compose.yml 配置要点

```yaml
services:
  backend:
    platform: linux/arm64  # 适配M3芯片
    build:
      context: ./backend
      dockerfile: Dockerfile  # 使用多阶段构建
    environment:
      DATABASE_URL: postgresql://excel2doc:excel2doc123@postgres:5432/excel2doc
      REDIS_URL: redis://redis:6379/0
      # ... 其他环境变量
```

## 优化特性

### 1. Docker缓存优化
- **指令顺序优化**：先复制requirements.txt，再安装依赖，最后复制源代码
- **BuildKit缓存**：使用 `--mount=type=cache` 缓存pip下载
- **.dockerignore**：排除不必要文件，减少构建上下文

### 2. 缓存效果
- **首次构建**：约6分钟（包含Rust工具链安装）
- **代码更新**：几秒钟（命中依赖缓存）
- **依赖更新**：1-2分钟（复用pip缓存）

### 3. 安全优化
- 使用非root用户运行服务
- 精简运行环境，移除编译工具
- 最小化镜像体积

## 常见问题

### Q1: 构建时间过长
**A:** 首次构建需要下载Rust工具链，约6分钟正常。后续构建会利用Docker缓存显著加速。

### Q2: ARM64编译失败
**A:** 确保docker-compose.yml中设置了 `platform: linux/arm64`，并使用多阶段构建的Dockerfile。

### Q3: 依赖安装失败
**A:** 检查网络连接，确保能访问PyPI和Rust官方源。可考虑配置镜像源加速。

### Q4: 容器启动失败
**A:** 
```bash
# 检查容器日志
docker-compose logs backend

# 检查依赖服务状态
docker-compose ps
```

## 维护操作

### 日常操作

```bash
# 查看服务状态
docker-compose ps

# 查看实时日志
docker-compose logs -f backend

# 重启服务
docker-compose restart backend

# 停止所有服务
docker-compose down
```

### 更新代码

```bash
# 代码更新后重新构建（利用缓存，很快）
docker-compose build backend
docker-compose up -d backend
```

### 更新依赖

```bash
# 修改requirements.txt后
docker-compose build --no-cache backend
docker-compose up -d backend
```

### 清理资源

```bash
# 停止并移除容器
docker-compose down

# 清理未使用的镜像
docker image prune

# 清理构建缓存（谨慎使用）
docker builder prune
```

### 数据库操作

```bash
# 进入数据库容器
docker-compose exec postgres psql -U excel2doc -d excel2doc

# 运行数据库迁移
docker-compose exec backend alembic upgrade head

# 查看迁移历史
docker-compose exec backend alembic history
```

### 调试模式

```bash
# 进入后端容器进行调试
docker-compose exec backend /bin/bash

# 运行测试
docker-compose exec backend pytest

# 检查Python环境
docker-compose exec backend pip list
```

## 性能监控

### 资源使用情况
```bash
# 查看容器资源使用
docker stats

# 查看镜像大小
docker images | grep excel2doc
```

### 健康检查
```bash
# 检查API健康状态
curl http://localhost:8000/health

# 检查数据库连接
docker-compose exec backend python -c "from app.core.database import engine; print('DB OK' if engine else 'DB Error')"
```

## 生产部署注意事项

1. **环境变量**：确保生产环境的敏感信息通过环境变量传入
2. **数据持久化**：使用Docker volumes持久化数据库数据
3. **日志管理**：配置日志收集和轮转
4. **资源限制**：在docker-compose.yml中设置内存和CPU限制
5. **健康检查**：配置应用级健康检查端点

## 相关文档

- [容器编译问题处理方法.md](./容器编译问题处理方法.md) - 详细的编译问题解决方案
- [加快编译的方法.md](./加快编译的方法.md) - Docker缓存优化策略
- [项目战术执行/00_功能架构设计文档.md](./项目战术执行/00_功能架构设计文档.md) - 系统架构设计

---

**维护人员**: 开发团队  
**更新时间**: 2025-07-10  
**版本**: v1.0

