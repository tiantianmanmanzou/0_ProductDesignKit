# GitHub Actions 运行时一致性检查配置示例
# 文件位置: .github/workflows/runtime-consistency-check.yml

name: Runtime API Consistency Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/**'

jobs:
  runtime-consistency-check:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: excel2doc
          POSTGRES_USER: excel2doc
          POSTGRES_DB: excel2doc_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: '3.9'
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install Python dependencies
      run: |
        cd backend
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install aiohttp  # 运行时检查需要
    
    - name: Install Node.js dependencies
      run: |
        cd frontend
        npm ci
    
    - name: Setup test database
      run: |
        cd backend
        export DATABASE_URL=postgresql://excel2doc:excel2doc@localhost/excel2doc_test
        alembic upgrade head
      env:
        DATABASE_URL: postgresql://excel2doc:excel2doc@localhost/excel2doc_test
    
    # 静态检查
    - name: Run naming convention check
      run: |
        python 0_ProductDesignKit/review/scripts/check_naming_convention.py --verbose
    
    - name: Run API consistency check
      run: |
        python 0_ProductDesignKit/review/scripts/check_api_consistency.py --report
    
    - name: Run enum usage analysis
      run: |
        python 0_ProductDesignKit/review/scripts/enum_usage_analyzer.py --verbose --report
    
    # 运行时检查
    - name: Run runtime API consistency check
      run: |
        python 0_ProductDesignKit/review/scripts/runtime_api_consistency_check.py --report
      env:
        DATABASE_URL: postgresql://excel2doc:excel2doc@localhost/excel2doc_test
        
    # 上传检查报告
    - name: Upload consistency check reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: consistency-check-reports
        path: |
          api_consistency_report.json
          enum-usage-analysis-report.json
          runtime-check-report.json
        retention-days: 30
    
    # 检查结果评估
    - name: Evaluate check results
      run: |
        echo "📊 一致性检查完成"
        echo "📄 查看 Actions Artifacts 中的详细报告"
        
        # 如果有严重错误，构建失败
        if [ -f "runtime-check-report.json" ]; then
          FAILED_TESTS=$(python -c "
import json
with open('runtime-check-report.json', 'r') as f:
    data = json.load(f)
    print(data['summary']['failed_tests'])
" 2>/dev/null || echo "0")
          
          if [ "$FAILED_TESTS" -gt "0" ]; then
            echo "❌ 发现 $FAILED_TESTS 个运行时一致性问题"
            exit 1
          else
            echo "✅ 所有运行时一致性检查通过"
          fi
        fi