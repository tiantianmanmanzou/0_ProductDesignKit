# Docker Compose é…ç½®ç”¨äºä¸€è‡´æ€§æ£€æŸ¥ç¯å¢ƒ
# æ–‡ä»¶ä½ç½®: docker-compose.check.yml

version: '3.8'

services:
  # æ•°æ®åº“æœåŠ¡
  postgres-check:
    image: postgres:13
    container_name: excel2doc-postgres-check
    environment:
      POSTGRES_DB: excel2doc_check
      POSTGRES_USER: excel2doc
      POSTGRES_PASSWORD: excel2doc
    ports:
      - "5433:5432"
    volumes:
      - postgres_check_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U excel2doc"]
      interval: 10s
      timeout: 5s
      retries: 5
  
  # åç«¯æœåŠ¡
  backend-check:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: excel2doc-backend-check
    environment:
      - DATABASE_URL=postgresql://excel2doc:excel2doc@postgres-check:5432/excel2doc_check
      - DEBUG=False
      - TESTING=True
    ports:
      - "8001:8000"
    depends_on:
      postgres-check:
        condition: service_healthy
    volumes:
      - ./backend:/app
      - backend_uploads:/app/uploads
    command: >
      sh -c "
        alembic upgrade head &&
        uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
  
  # ä¸€è‡´æ€§æ£€æŸ¥æœåŠ¡
  consistency-checker:
    image: python:3.9
    container_name: excel2doc-consistency-checker
    working_dir: /workspace
    environment:
      - API_BASE_URL=http://backend-check:8000
    volumes:
      - .:/workspace
    depends_on:
      backend-check:
        condition: service_healthy
    command: >
      sh -c "
        echo 'ğŸ” å¼€å§‹è¿è¡Œä¸€è‡´æ€§æ£€æŸ¥...' &&
        pip install --quiet aiohttp requests &&
        
        echo '1ï¸âƒ£ è¿è¡Œå‘½åè§„èŒƒæ£€æŸ¥...' &&
        python 0_ProductDesignKit/review/scripts/check_naming_convention.py --verbose &&
        
        echo '2ï¸âƒ£ è¿è¡ŒAPIä¸€è‡´æ€§æ£€æŸ¥...' &&
        python 0_ProductDesignKit/review/scripts/check_api_consistency.py --report &&
        
        echo '3ï¸âƒ£ è¿è¡Œæšä¸¾ä½¿ç”¨åˆ†æ...' &&
        python 0_ProductDesignKit/review/scripts/enum_usage_analyzer.py --verbose --report &&
        
        echo '4ï¸âƒ£ è¿è¡Œè¿è¡Œæ—¶APIä¸€è‡´æ€§æ£€æŸ¥...' &&
        python 0_ProductDesignKit/review/scripts/runtime_api_consistency_check.py --report &&
        
        echo 'âœ… æ‰€æœ‰ä¸€è‡´æ€§æ£€æŸ¥å®Œæˆï¼' &&
        echo 'ğŸ“„ æ£€æŸ¥æŠ¥å‘Šæ–‡ä»¶:' &&
        ls -la *.json 2>/dev/null || echo '   (æœªç”ŸæˆæŠ¥å‘Šæ–‡ä»¶)'
      "
  
  # æŠ¥å‘Šæ”¶é›†æœåŠ¡
  report-collector:
    image: nginx:alpine
    container_name: excel2doc-report-server
    ports:
      - "8080:80"
    volumes:
      - .:/usr/share/nginx/html:ro
      - ./0_ProductDesignKit/review/ci-cd-examples/nginx-reports.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - consistency-checker
    profiles:
      - reports

volumes:
  postgres_check_data:
    driver: local
  backend_uploads:
    driver: local

# ç½‘ç»œé…ç½®
networks:
  default:
    name: excel2doc-check-network